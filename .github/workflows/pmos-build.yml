name: Build PostmarketOS for Samsung Goyawifi

on:
  workflow_dispatch:
    inputs:
      include_firefox:
        description: 'Include Firefox'
        required: false
        type: boolean
        default: true
      extra_packages:
        description: 'Extra packages to include (space-separated)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            python3 \
            python3-pip
      - name: Install pmbootstrap
        run: |
          # Clone pmbootstrap from GitLab
          git clone --depth=1 https://gitlab.com/postmarketOS/pmbootstrap.git
          cd pmbootstrap
          
          # Install dependencies
          pip3 install --user -r requirements.txt
          
          # Add pmbootstrap to PATH
          echo "$GITHUB_WORKSPACE/pmbootstrap" >> $GITHUB_PATH
      
      - name: Initialize pmbootstrap
        run: |
          # Create config directory
          mkdir -p ~/.config
          
          # Initialize pmbootstrap with our settings
          cd pmbootstrap
          yes '' | ./pmbootstrap.py init || true
          
          # Configure pmbootstrap
          ./pmbootstrap.py config device samsung-goyawifi
          ./pmbootstrap.py config ui lxqt
          ./pmbootstrap.py config kernel downstream
          ./pmbootstrap.py config extra_packages "none"
          ./pmbootstrap.py config timezone UTC
          ./pmbootstrap.py config mirrors "https://mirror.postmarketos.org/postmarketos/"
          
          # Set work directory
          ./pmbootstrap.py config work "$HOME/.local/var/pmbootstrap"
      
      - name: Update pmaports to edge
        run: |
          cd ~/.local/var/pmbootstrap/cache_git/pmaports
          git fetch origin
          git checkout edge
          git pull origin edge
      
      - name: Build packages list
        id: packages
        run: |
          PACKAGES="firefox-esr"
          
          if [ "${{ github.event.inputs.include_firefox }}" = "true" ]; then
            echo "Including Firefox ESR"
          else
            PACKAGES=""
          fi
          
          if [ -n "${{ github.event.inputs.extra_packages }}" ]; then
            PACKAGES="$PACKAGES ${{ github.event.inputs.extra_packages }}"
          fi
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Building with packages: $PACKAGES"
      
      - name: Install packages to rootfs
        if: steps.packages.outputs.packages != ''
        run: |
          cd pmbootstrap
          ./pmbootstrap.py install --add ${{ steps.packages.outputs.packages }}
      
      - name: Build and export recovery zip
        run: |
          cd pmbootstrap
          
          # Install base system with LXQt
          ./pmbootstrap.py install
          
          # Export as android recovery flashable zip
          ./pmbootstrap.py export --flavor=android-recovery-zip
      
      - name: Get build artifacts
        id: artifacts
        run: |
          # pmbootstrap exports to ~/postmarketos-export by default
          EXPORT_DIR="$HOME/postmarketos-export"
          
          # Find the generated zip file
          ZIP_FILE=$(find "$EXPORT_DIR" -name "*.zip" -type f 2>/dev/null | head -n 1)
          
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: No zip file found in $EXPORT_DIR!"
            echo "Contents of export directory:"
            ls -la "$EXPORT_DIR" 2>/dev/null || echo "Export directory doesn't exist"
            exit 1
          fi
          
          # Get file info
          FILE_NAME=$(basename "$ZIP_FILE")
          FILE_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
          
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          
          echo "Found: $FILE_NAME ($FILE_SIZE)"
      
      - name: Generate build info
        run: |
          cat > build-info.txt << EOF
          PostmarketOS Build Information
          ==============================
          Device: Samsung Galaxy Tab 3 Lite (goyawifi)
          Model: SM-T111/T110
          Branch: edge
          Desktop: LXQt
          Kernel: downstream
          Architecture: armv7
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          Packages included:
          ${{ steps.packages.outputs.packages }}
          
          Installation Instructions:
          1. Boot into recovery mode (TWRP/CWM recommended)
          2. Backup your current system
          3. Flash the zip file
          4. Wipe cache/dalvik
          5. Reboot
          
          Default credentials:
          Username: user
          Password: 147147
          
          Note: You may need to change the password on first boot.
          EOF
          
          cat build-info.txt
      
      - name: Upload recovery zip
        uses: actions/upload-artifact@v4
        with:
          name: postmarketos-samsung-goyawifi-lxqt
          path: |
            ${{ steps.artifacts.outputs.zip_file }}
            build-info.txt
          retention-days: 30
      
      - name: Build summary
        run: |
          echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Device:** Samsung Galaxy Tab 3 Lite (goyawifi)" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ steps.artifacts.outputs.file_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ steps.artifacts.outputs.file_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Boot your device into recovery mode" >> $GITHUB_STEP_SUMMARY
          echo "3. Flash the zip file" >> $GITHUB_STEP_SUMMARY
          echo "4. Reboot and enjoy PostmarketOS!" >> $GITHUB_STEP_SUMMARY
